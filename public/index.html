<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نتائج تحاليل Real Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; }
        .header { background: #0d6efd; color: white; padding: 20px 0; text-align: center; margin-bottom: 30px; }
        .file-card { transition: transform 0.2s; cursor: pointer; border: none; shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .file-card:hover { transform: translateY(-5px); }
        .file-icon { font-size: 3rem; color: #dc3545; }
        .file-icon.image { color: #198754; }
        #loading { text-align: center; margin-top: 50px; }
        .error-msg { color: #dc3545; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="header">
    <h1>نتائج تحاليل معمل Real Lab</h1>
    <p>بوابتك الإلكترونية للحصول على النتائج</p>
</div>

<div class="container">
    <div id="loading">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">جاري تحميل النتائج...</p>
    </div>

    <div id="error-container" class="error-msg" style="display:none;"></div>

    <div id="files-container" class="row g-4" style="display:none;">
        </div>
</div>

<script>
    // 1. استخراج رقم المريض من الرابط
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get('id');

    async function loadFiles() {
        if (!patientId) {
            showError("رابط غير صالح. يرجى التأكد من الرابط المرسل إليك.");
            return;
        }

        try {
            // استدعاء Function لجلب الملفات
            const response = await fetch(`/.netlify/functions/get-files?id=${patientId}`);
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || "فشل في جلب الملفات");

            if (data.length === 0) {
                showError("لا توجد ملفات متاحة لهذا المريض حالياً.");
                return;
            }

            renderFiles(data);
        } catch (err) {
            console.error(err);
            showError("حدث خطأ أثناء تحميل النتائج. حاول مرة أخرى لاحقاً.");
        }
    }

    function renderFiles(files) {
        const container = document.getElementById('files-container');
        document.getElementById('loading').style.display = 'none';
        container.style.display = 'flex';

        files.forEach(file => {
            const isPdf = file.mimeType.includes('pdf');
            const iconClass = isPdf ? 'bi-file-pdf file-icon' : 'bi-file-image file-icon image';
            const iconHtml = isPdf 
                ? '<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="currentColor" class="bi bi-file-earmark-pdf text-danger" viewBox="0 0 16 16"><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/><path d="M4.603 14.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 3.798-.865c.267 0 .62.032.904.09.283.058.483.143.605.263.15.148.196.35.151.522-.046.19-.155.367-.353.514-.127.094-.27.163-.479.212-.27.063-.646.09-1.077.085-.693-.01-1.374-.175-1.925-.334a6.56 6.56 0 0 0-.61-.176c.264.63.515 1.15.69 1.498.02.04.04.08.058.118a1.27 1.27 0 0 1 .054.34c0 .252-.11.493-.338.646a.859.859 0 0 1-.568.16c-.22 0-.394-.09-.494-.205z"/></svg>'
                : '<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="currentColor" class="bi bi-file-earmark-image text-success" viewBox="0 0 16 16"><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/></svg>';

            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4';
            col.innerHTML = `
                <div class="card file-card p-4 text-center" onclick="openFile('${file.id}', '${file.webViewLink}', '${file.name}')">
                    <div class="mb-3">${iconHtml}</div>
                    <h5 class="card-title text-dark">${file.name}</h5>
                    <p class="text-muted small">اضغط للعرض</p>
                </div>
            `;
            container.appendChild(col);
        });
    }

    async function openFile(fileId, link, fileName) {
        // 1. تسجيل الحدث في الخلفية (بدون انتظار)
        fetch('/.netlify/functions/log-access', {
            method: 'POST',
            body: JSON.stringify({ patientId, fileName })
        });

        // 2. فتح الملف فوراً
        window.open(link, '_blank');
    }

    function showError(msg) {
        document.getElementById('loading').style.display = 'none';
        const errDiv = document.getElementById('error-container');
        errDiv.textContent = msg;
        errDiv.style.display = 'block';
    }

    loadFiles();
</script>

</body>
</html>